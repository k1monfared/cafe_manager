{% extends "base.html" %}
{% set active_page = "drive" %}

{% block title %}Google Drive Integration - Cafe Supply Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-cloud"></i> Google Drive Integration</h1>
    <div>
        <button class="btn btn-success" onclick="syncAllDriveFiles()" id="syncAllBtn" disabled>
            <i class="bi bi-arrow-repeat"></i> Sync All Files
        </button>
        <button class="btn btn-primary" onclick="authenticateGoogleDrive()" id="authBtn">
            <i class="bi bi-key"></i> Connect to Google Drive
        </button>
    </div>
</div>

<!-- Connection Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="connectionStatus">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-wifi"></i> Connection Status</h5>
            </div>
            <div class="card-body">
                <div class="text-center text-muted">
                    <i class="bi bi-hourglass-split"></i> Checking connection...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Setup Instructions (shown when not connected) -->
<div class="row mb-4" id="setupInstructions" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> First Time Setup Required</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Google Drive API Setup Required</strong><br>
                    To connect to Google Drive, you need to set up API credentials first.
                </div>
                
                <div class="accordion" id="setupAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                üìã Step-by-Step Setup Instructions
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#setupAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li><strong>Go to Google Cloud Console:</strong> 
                                        <a href="https://console.cloud.google.com/" target="_blank">https://console.cloud.google.com/</a>
                                    </li>
                                    <li><strong>Create or select a project</strong></li>
                                    <li><strong>Enable Google Drive API:</strong>
                                        <ul>
                                            <li>Go to "APIs & Services" ‚Üí "Library"</li>
                                            <li>Search for "Google Drive API"</li>
                                            <li>Click "Enable"</li>
                                        </ul>
                                    </li>
                                    <li><strong>Create OAuth 2.0 credentials:</strong>
                                        <ul>
                                            <li>Go to "APIs & Services" ‚Üí "Credentials"</li>
                                            <li>Click "Create Credentials" ‚Üí "OAuth 2.0 Client IDs"</li>
                                            <li>Choose "Desktop application"</li>
                                            <li>Download the JSON file</li>
                                        </ul>
                                    </li>
                                    <li><strong>Save the credentials:</strong>
                                        <ul>
                                            <li>Rename the downloaded file to <code>google_credentials.json</code></li>
                                            <li>Place it in your cafe_manager folder</li>
                                        </ul>
                                    </li>
                                    <li><strong>Install required packages:</strong>
                                        <code>pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib</code>
                                    </li>
                                    <li><strong>Restart the cafe manager application</strong></li>
                                </ol>
                                
                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-lightbulb"></i> <strong>Need help?</strong> The setup only needs to be done once. 
                                    After that, you can easily sync your Google Sheets with one click!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Drive File Connections (shown when connected) -->
<div class="row mb-4" id="driveConnections" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Connect Your Google Sheets</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Current Inventory -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-box-seam"></i> Current Inventory</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="form-label">Google Sheets URL:</label>
                                    <input type="url" class="form-control" id="inventoryUrl" 
                                           placeholder="https://docs.google.com/spreadsheets/d/...">
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary" onclick="connectSheet('inventory', 'inventoryUrl')">
                                        <i class="bi bi-link"></i> Connect Sheet
                                    </button>
                                </div>
                                <div class="mt-2" id="inventoryStatus">
                                    <small class="text-muted">Not connected</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Usage -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-calendar-day"></i> Daily Usage</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="form-label">Google Sheets URL:</label>
                                    <input type="url" class="form-control" id="usageUrl" 
                                           placeholder="https://docs.google.com/spreadsheets/d/...">
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-outline-success" onclick="connectSheet('usage', 'usageUrl')">
                                        <i class="bi bi-link"></i> Connect Sheet
                                    </button>
                                </div>
                                <div class="mt-2" id="usageStatus">
                                    <small class="text-muted">Not connected</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order History -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0"><i class="bi bi-cart"></i> Order History</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="form-label">Google Sheets URL:</label>
                                    <input type="url" class="form-control" id="ordersUrl" 
                                           placeholder="https://docs.google.com/spreadsheets/d/...">
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-outline-warning" onclick="connectSheet('orders', 'ordersUrl')">
                                        <i class="bi bi-link"></i> Connect Sheet
                                    </button>
                                </div>
                                <div class="mt-2" id="ordersStatus">
                                    <small class="text-muted">Not connected</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Suppliers -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-building"></i> Suppliers</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="form-label">Google Sheets URL:</label>
                                    <input type="url" class="form-control" id="suppliersUrl" 
                                           placeholder="https://docs.google.com/spreadsheets/d/...">
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-outline-info" onclick="connectSheet('suppliers', 'suppliersUrl')">
                                        <i class="bi bi-link"></i> Connect Sheet
                                    </button>
                                </div>
                                <div class="mt-2" id="suppliersStatus">
                                    <small class="text-muted">Not connected</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>How to get the URL:</strong> Open your Google Sheet ‚Üí Click "Share" ‚Üí Copy the link. 
                    Make sure sharing is set to "Anyone with the link can view" or give access to your Google account.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Results -->
<div class="row" id="syncResults" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-check-square"></i> Sync Results</h5>
            </div>
            <div class="card-body" id="syncResultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="/sheets" class="btn btn-outline-primary w-100">
                            <i class="bi bi-file-spreadsheet"></i><br>
                            Manual CSV Upload
                        </a>
                        <small class="text-muted d-block mt-1">Upload CSV files directly</small>
                    </div>
                    <div class="col-md-3">
                        <a href="/static/templates/current_inventory_template.csv" class="btn btn-outline-success w-100" download>
                            <i class="bi bi-download"></i><br>
                            Download Templates
                        </a>
                        <small class="text-muted d-block mt-1">Get Google Sheets templates</small>
                    </div>
                    <div class="col-md-3">
                        <a href="/" class="btn btn-outline-info w-100">
                            <i class="bi bi-speedometer2"></i><br>
                            View Dashboard
                        </a>
                        <small class="text-muted d-block mt-1">See recommendations</small>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" onclick="checkGoogleDriveStatus()">
                            <i class="bi bi-arrow-clockwise"></i><br>
                            Refresh Status
                        </button>
                        <small class="text-muted d-block mt-1">Check connection</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isAuthenticated = false;
let connectedSheets = {};

function checkGoogleDriveStatus() {
    fetch('/api/google_drive_status')
        .then(response => response.json())
        .then(data => {
            updateConnectionStatus(data);
        })
        .catch(error => {
            console.error('Error checking Google Drive status:', error);
            updateConnectionStatus({
                success: false,
                message: 'Connection check failed',
                authenticated: false
            });
        });
}

function updateConnectionStatus(status) {
    const statusCard = document.getElementById('connectionStatus');
    const setupInstructions = document.getElementById('setupInstructions');
    const driveConnections = document.getElementById('driveConnections');
    const authBtn = document.getElementById('authBtn');
    const syncBtn = document.getElementById('syncAllBtn');
    
    isAuthenticated = status.authenticated;
    
    if (status.authenticated) {
        // Connected
        statusCard.innerHTML = `
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Connected to Google Drive</h5>
            </div>
            <div class="card-body">
                <p class="text-success mb-0">
                    <i class="bi bi-check-circle"></i> Successfully connected to Google Drive
                </p>
                <small class="text-muted">You can now connect your Google Sheets below</small>
            </div>
        `;
        
        setupInstructions.style.display = 'none';
        driveConnections.style.display = 'block';
        authBtn.textContent = '‚úÖ Connected';
        authBtn.disabled = true;
        authBtn.className = 'btn btn-success';
        syncBtn.disabled = false;
        
    } else {
        // Not connected
        statusCard.innerHTML = `
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Google Drive Not Connected</h5>
            </div>
            <div class="card-body">
                <p class="text-warning mb-2">
                    <i class="bi bi-exclamation-triangle"></i> ${status.message || 'Not authenticated'}
                </p>
                <small class="text-muted">Click "Connect to Google Drive" to set up access</small>
            </div>
        `;
        
        setupInstructions.style.display = 'block';
        driveConnections.style.display = 'none';
        authBtn.textContent = 'üîê Connect to Google Drive';
        authBtn.disabled = false;
        authBtn.className = 'btn btn-primary';
        syncBtn.disabled = true;
    }
}

function authenticateGoogleDrive() {
    const authBtn = document.getElementById('authBtn');
    authBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Connecting...';
    authBtn.disabled = true;
    
    fetch('/api/google_drive_auth', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('‚úÖ Successfully connected to Google Drive!', 'success');
            checkGoogleDriveStatus();
        } else {
            showAlert(`‚ùå Connection failed: ${data.message}`, 'danger');
            authBtn.innerHTML = 'üîê Connect to Google Drive';
            authBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Authentication error:', error);
        showAlert('‚ùå Authentication failed: Network error', 'danger');
        authBtn.innerHTML = 'üîê Connect to Google Drive';
        authBtn.disabled = false;
    });
}

function connectSheet(fileType, urlInputId) {
    const urlInput = document.getElementById(urlInputId);
    const sheetUrl = urlInput.value.trim();
    
    if (!sheetUrl) {
        showAlert('Please enter a Google Sheets URL', 'warning');
        return;
    }
    
    const statusDiv = document.getElementById(`${fileType}Status`);
    statusDiv.innerHTML = '<small class="text-info"><i class="bi bi-hourglass-split"></i> Connecting...</small>';
    
    fetch('/api/connect_google_sheet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            sheet_url: sheetUrl,
            file_type: fileType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            connectedSheets[fileType] = sheetUrl;
            statusDiv.innerHTML = `
                <small class="text-success">
                    <i class="bi bi-check-circle"></i> Connected: ${data.sheet_info.name}
                </small>
            `;
            showAlert(`‚úÖ Successfully connected ${data.sheet_info.name}`, 'success');
        } else {
            statusDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> Connection failed</small>';
            showAlert(`‚ùå Connection failed: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Connection error:', error);
        statusDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> Connection failed</small>';
        showAlert('‚ùå Connection failed: Network error', 'danger');
    });
}

function syncAllDriveFiles() {
    if (Object.keys(connectedSheets).length === 0) {
        showAlert('Please connect at least one Google Sheet first', 'warning');
        return;
    }
    
    const syncBtn = document.getElementById('syncAllBtn');
    const originalText = syncBtn.innerHTML;
    syncBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Syncing...';
    syncBtn.disabled = true;
    
    fetch('/api/sync_google_drive_links', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            drive_links: connectedSheets
        })
    })
    .then(response => response.json())
    .then(data => {
        displaySyncResults(data);
        if (data.success) {
            showAlert(`üéâ Successfully synced ${data.successful_files.length} files!`, 'success');
            // Redirect to dashboard after successful sync
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        } else {
            showAlert(`‚ùå Sync failed: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Sync error:', error);
        showAlert('‚ùå Sync failed: Network error', 'danger');
    })
    .finally(() => {
        syncBtn.innerHTML = originalText;
        syncBtn.disabled = false;
    });
}

function displaySyncResults(data) {
    const resultsDiv = document.getElementById('syncResults');
    const contentDiv = document.getElementById('syncResultsContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-success">‚úÖ Successfully Downloaded</h6>
                <ul class="list-group mb-3">
    `;
    
    if (data.download_results) {
        Object.entries(data.download_results).forEach(([fileType, success]) => {
            if (success) {
                html += `<li class="list-group-item list-group-item-success">${fileType}</li>`;
            }
        });
    }
    
    html += `
                </ul>
                <h6 class="text-primary">üîÑ Successfully Synced</h6>
                <ul class="list-group">
    `;
    
    if (data.successful_files) {
        data.successful_files.forEach(file => {
            html += `<li class="list-group-item list-group-item-success">${file}</li>`;
        });
    }
    
    html += `
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="text-danger">‚ùå Failed Downloads</h6>
                <ul class="list-group">
    `;
    
    if (data.download_results) {
        Object.entries(data.download_results).forEach(([fileType, success]) => {
            if (!success) {
                html += `<li class="list-group-item list-group-item-danger">${fileType}</li>`;
            }
        });
    }
    
    html += '</ul></div></div>';
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Check status when page loads
document.addEventListener('DOMContentLoaded', function() {
    checkGoogleDriveStatus();
});
</script>
{% endblock %}