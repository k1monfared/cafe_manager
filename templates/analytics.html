{% extends "simple_base.html" %}

{% block title %}Analytics - Simple Inventory Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-graph-up"></i> Analytics & Explanations</h1>
        <p class="text-muted">Detailed consumption analysis and forecasting explanations</p>
    </div>
</div>

{% if forecast_data %}
<!-- Forecasts with Charts -->
{% for item in forecast_data %}
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-box"></i> {{ item.item_name }}</h5>
        <div class="row text-center">
            <div class="col-md-3">
                <small class="text-muted">Current Stock</small><br>
                <strong>{{ "%.1f"|format(item.current_stock) }} {{ item.unit }}</strong>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Daily Usage</small><br>
                <strong>{{ "%.1f"|format(item.avg_daily_consumption) }} {{ item.unit }}/day</strong>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Days Remaining</small><br>
                <strong class="text-{{ 'danger' if item.days_remaining < 3 else 'warning' if item.days_remaining < 7 else 'success' }}">{{ "%.1f"|format(item.days_remaining) }} days</strong>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Forecast Quality</small><br>
                <span class="badge bg-{{ 'success' if item.confidence == 'High' else 'warning' if item.confidence == 'Medium' else 'secondary' }}">{{ item.confidence }}</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Enhanced Charts with Toggle -->
        {% if item.chart_dates and item.chart_consumption %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6><i class="bi bi-bar-chart"></i> Data Visualization (Last 14 Days)</h6>
            <div class="btn-group btn-group-sm" role="group">
                <input type="radio" class="btn-check" name="chartType{{ loop.index }}" id="consumption{{ loop.index }}" checked>
                <label class="btn btn-outline-primary" for="consumption{{ loop.index }}">Consumption</label>
                
                <input type="radio" class="btn-check" name="chartType{{ loop.index }}" id="stock{{ loop.index }}">
                <label class="btn btn-outline-primary" for="stock{{ loop.index }}">Stock Levels</label>
                
                <input type="radio" class="btn-check" name="chartType{{ loop.index }}" id="combined{{ loop.index }}">
                <label class="btn btn-outline-primary" for="combined{{ loop.index }}">Combined</label>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="chart-{{ loop.index }}"></canvas>
        </div>
        {% endif %}
        
        <!-- Forecast Details -->
        <div class="row mt-3">
            <div class="col-md-6">
                <h6><i class="bi bi-info-circle"></i> Stock Information</h6>
                <ul class="list-unstyled">
                    <li><strong>Current Stock:</strong> {{ "%.1f"|format(item.current_stock) }} {{ item.unit }}</li>
                    <li><strong>Minimum Threshold:</strong> {{ "%.1f"|format(item.min_threshold) }} {{ item.unit }}</li>
                    <li><strong>Maximum Capacity:</strong> {{ "%.1f"|format(item.max_capacity) }} {{ item.unit }}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-calculator"></i> Usage Analysis</h6>
                <ul class="list-unstyled">
                    <li><strong>Average Daily Usage:</strong> {{ "%.2f"|format(item.avg_daily_consumption) }} {{ item.unit }}/day</li>
                    <li><strong>Estimated Runout:</strong> {{ item.runout_date }}</li>
                    <li><strong>Data Points Used:</strong> {{ item.data_points }} days</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<div class="alert alert-info">
    <h5><i class="bi bi-info-circle"></i> No Forecast Data Available</h5>
    <p>Upload consumption and delivery data to generate analysis and forecasts.</p>
</div>
{% endif %}

<!-- Purchase Recommendations -->
{% if recommendations %}
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-cart-plus"></i> Purchase Recommendations</h5>
    </div>
    <div class="card-body">
        {% include 'recommendation_table.html' %}
    </div>
</div>
{% else %}
<div class="alert alert-success">
    <h5><i class="bi bi-check-circle"></i> No Purchase Recommendations</h5>
    <p>All items have sufficient stock levels. Great job managing your inventory!</p>
</div>
{% endif %}

<!-- Manual Recalculate -->
<div class="card">
    <div class="card-body text-center">
        <h6>Data Not Looking Right?</h6>
        <button id="recalculateBtn" class="btn btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Recalculate Analytics
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Enhanced charts with toggle functionality
{% if forecast_data %}
{% for item in forecast_data %}
{% if item.chart_dates and item.chart_consumption %}
(function() {
    const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
    const chartData{{ loop.index }} = {
        labels: {{ item.chart_dates|safe }},
        datasets: {
            consumption: {
                label: 'Daily Consumption ({{ item.unit }})',
                data: {{ item.chart_consumption|safe }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true,
                type: 'line'
            },
            stock: {
                label: 'Stock Level ({{ item.unit }})',
                data: {{ item.chart_stock_levels|safe }},
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.1,
                fill: false,
                type: 'line'
            }
        }
    };
    
    const deliveryMarkers{{ loop.index }} = {{ item.delivery_markers|safe }};
    
    let chart{{ loop.index }} = new Chart(ctx{{ loop.index }}, {
        type: 'line',
        data: {
            labels: chartData{{ loop.index }}.labels,
            datasets: [chartData{{ loop.index }}.datasets.consumption]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount ({{ item.unit }})'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '{{ item.item_name }} - Consumption Pattern'
                },
                annotation: {
                    annotations: {}
                }
            }
        },
        plugins: [{
            id: 'deliveryMarkers',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                
                deliveryMarkers{{ loop.index }}.forEach(function(marker) {
                    const x = chart.scales.x.getPixelForValue(marker.x);
                    const yBottom = chartArea.bottom;
                    const yTop = chartArea.top;
                    
                    // Draw vertical line
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yTop);
                    ctx.lineTo(x, yBottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = 'rgba(255, 99, 132, 0.8)';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    
                    // Draw delivery amount label
                    ctx.fillStyle = 'rgba(255, 99, 132, 0.9)';
                    ctx.font = '12px Arial';
                    ctx.fillText('D: ' + marker.amount, x + 5, yTop + 15);
                    ctx.restore();
                });
            }
        }]
    });
    
    function updateChart{{ loop.index }}(type) {
        let datasets = [];
        let title = '{{ item.item_name }} - ';
        
        switch(type) {
            case 'consumption':
                datasets = [chartData{{ loop.index }}.datasets.consumption];
                title += 'Consumption Pattern';
                break;
            case 'stock':
                datasets = [chartData{{ loop.index }}.datasets.stock];
                title += 'Stock Levels';
                break;
            case 'combined':
                // Use dual y-axis for combined view
                datasets = [
                    {...chartData{{ loop.index }}.datasets.consumption, yAxisID: 'y'},
                    {...chartData{{ loop.index }}.datasets.stock, yAxisID: 'y1'}
                ];
                title += 'Consumption vs Stock';
                break;
        }
        
        chart{{ loop.index }}.data.datasets = datasets;
        chart{{ loop.index }}.options.plugins.title.text = title;
        
        // Update scales for combined view
        if (type === 'combined') {
            chart{{ loop.index }}.options.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Stock Level ({{ item.unit }})'
                },
                grid: {
                    drawOnChartArea: false,
                }
            };
            chart{{ loop.index }}.options.scales.y.title.text = 'Consumption ({{ item.unit }})';
        } else {
            delete chart{{ loop.index }}.options.scales.y1;
            chart{{ loop.index }}.options.scales.y.title.text = 'Amount ({{ item.unit }})';
        }
        
        chart{{ loop.index }}.update();
    }
    
    // Add event listeners for toggle buttons
    document.getElementById('consumption{{ loop.index }}').addEventListener('change', function() {
        if (this.checked) updateChart{{ loop.index }}('consumption');
    });
    
    document.getElementById('stock{{ loop.index }}').addEventListener('change', function() {
        if (this.checked) updateChart{{ loop.index }}('stock');
    });
    
    document.getElementById('combined{{ loop.index }}').addEventListener('change', function() {
        if (this.checked) updateChart{{ loop.index }}('combined');
    });
})();
{% endif %}
{% endfor %}
{% endif %}

// Handle recalculate button
document.getElementById('recalculateBtn').addEventListener('click', function() {
    this.innerHTML = '<i class="bi bi-hourglass"></i> Recalculating...';
    this.disabled = true;
    
    fetch('/api/recalculate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.message);
                location.reload();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Network error: ' + error);
        })
        .finally(() => {
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Recalculate Analytics';
            this.disabled = false;
        });
});
</script>
{% endblock %}