{% extends "simple_base.html" %}

{% block title %}Analytics - Simple Inventory Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-graph-up"></i> Analytics & Explanations</h1>
        <p class="text-muted">Detailed consumption analysis and forecasting explanations</p>
    </div>
</div>

{% if forecast_data %}
<!-- Forecasts with Charts -->
{% for item in forecast_data %}
<div class="card mb-4">
    <div class="card-header item-toggle-header" data-item="{{ item.item_name|replace(' ', '_') }}" style="cursor: pointer;">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h5 class="mb-0"><i class="bi bi-box"></i> {{ item.item_name }}</h5>
                {% for rec in recommendations %}
                    {% if rec.Item_Name == item.item_name %}
                        <span class="badge ms-2 bg-{{ 'danger' if rec.Urgency == 'CRITICAL' else 'warning' if rec.Urgency == 'HIGH' else 'info' if rec.Urgency == 'MEDIUM' else 'secondary' if rec.Urgency == 'LOW' else 'success' }}">{{ rec.Urgency }}</span>
                    {% endif %}
                {% endfor %}
            </div>
            <i class="bi bi-chevron-down toggle-icon"></i>
        </div>
        <div class="row text-center mt-2">
            <div class="col-md-3">
                <small class="text-muted">Current Stock</small><br>
                <strong>{{ "%.1f"|format(item.current_stock) }} {{ item.unit }}</strong>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Daily Usage</small><br>
                <strong>{{ "%.1f"|format(item.avg_daily_consumption) }} {{ item.unit }}/day</strong>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Days Remaining</small><br>
                <strong class="text-{{ 'danger' if item.days_remaining < 3 else 'warning' if item.days_remaining < 7 else 'success' }}">{{ "%.1f"|format(item.days_remaining) }} days</strong>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Forecast Quality</small><br>
                <span class="badge bg-{{ 'success' if item.confidence == 'High' else 'warning' if item.confidence == 'Medium' else 'secondary' }}">{{ item.confidence }}</span>
            </div>
        </div>
    </div>
    <div class="card-body item-content" id="content-{{ item.item_name|replace(' ', '_') }}" style="display: none;">
        {% if item.chart_dates and item.chart_consumption %}
        <div class="d-flex justify-content-end mb-3">
            <div class="btn-group btn-group-sm" role="group">
                <input type="radio" class="btn-check" name="chartType{{ loop.index }}" id="consumption{{ loop.index }}" checked>
                <label class="btn btn-outline-primary" for="consumption{{ loop.index }}">Consumption</label>
                
                <input type="radio" class="btn-check" name="chartType{{ loop.index }}" id="stock{{ loop.index }}">
                <label class="btn btn-outline-primary" for="stock{{ loop.index }}">Stock Levels</label>
                
                <input type="radio" class="btn-check" name="chartType{{ loop.index }}" id="combined{{ loop.index }}">
                <label class="btn btn-outline-primary" for="combined{{ loop.index }}">Combined</label>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="chart-{{ loop.index }}"></canvas>
        </div>
        {% endif %}
        
        <div class="row mt-3">
            <div class="col-md-4">
                <h6 class="text-muted">Inventory Status</h6>
                <ul class="list-unstyled">
                    <li><strong>Current Stock:</strong> {{ "%.1f"|format(item.current_stock) }} {{ item.unit }}</li>
                    <li><strong>Minimum Threshold:</strong> {{ "%.1f"|format(item.min_threshold) }} {{ item.unit }}</li>
                    <li><strong>Maximum Capacity:</strong> {{ "%.1f"|format(item.max_capacity) }} {{ item.unit }}</li>
                    {% for rec in recommendations %}
                        {% if rec.Item_Name == item.item_name %}
                            <li><strong>Target Stock Level:</strong> {{ "%.1f"|format(rec.Target_Stock_Level) }} {{ item.unit }}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Usage Analytics</h6>
                <ul class="list-unstyled">
                    <li><strong>Average Daily Usage:</strong> {{ "%.2f"|format(item.avg_daily_consumption) }} {{ item.unit }}/day</li>
                    <li><strong>Estimated Runout:</strong> {{ item.runout_date }} ({{ "%.1f"|format(item.days_remaining) }} days remaining)</li>
                    <li><strong>Data Points Used:</strong> {{ item.data_points }} days</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Ordering Information</h6>
                <ul class="list-unstyled">
                    {% set found_rec = false %}
                    {% for rec in recommendations %}
                        {% if rec.Item_Name == item.item_name %}
                            <li><strong>Recommended Order:</strong> {{ "%.1f"|format(rec.Recommended_Quantity) }} {{ item.unit }}</li>
                            <li><strong>Lead Time:</strong> {{ rec.Lead_Time_Days }} days</li>
                            <li><strong>Stock Status:</strong> {{ rec.Urgency }}</li>
                            {% set found_rec = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not found_rec %}
                        <li><strong>Lead Time:</strong> {{ item_info[item.item_name].Lead_Time_Days if item_info and item.item_name in item_info else item.Lead_Time_Days }} days</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<div class="alert alert-info">
    <h5><i class="bi bi-info-circle"></i> No Forecast Data Available</h5>
    <p>Upload consumption and delivery data to generate analysis and forecasts.</p>
</div>
{% endif %}


<!-- Manual Recalculate -->
<div class="card">
    <div class="card-body text-center">
        <h6>Data Not Looking Right?</h6>
        <button id="recalculateBtn" class="btn btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Recalculate Analytics
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Enhanced charts with toggle functionality
{% if forecast_data %}
{% for item in forecast_data %}
{% if item.chart_dates and item.chart_consumption %}
(function() {
    const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
    const chartData{{ loop.index }} = {
        labels: {{ item.chart_dates|safe }},
        datasets: {
            consumption: {
                label: 'Daily Consumption ({{ item.unit }})',
                data: {{ item.chart_consumption|safe }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true,
                type: 'line'
            },
            stock: {
                label: 'Stock Level ({{ item.unit }})',
                data: {{ item.chart_stock_levels|safe }},
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.1,
                fill: false,
                type: 'line'
            }
        }
    };
    
    const deliveryMarkers{{ loop.index }} = {{ item.delivery_markers|safe }};
    
    let chart{{ loop.index }} = new Chart(ctx{{ loop.index }}, {
        type: 'line',
        data: {
            labels: chartData{{ loop.index }}.labels,
            datasets: [chartData{{ loop.index }}.datasets.consumption]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount ({{ item.unit }})'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: false
                },
                annotation: {
                    annotations: {}
                }
            }
        },
        plugins: [{
            id: 'deliveryMarkers',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                
                deliveryMarkers{{ loop.index }}.forEach(function(marker) {
                    const x = chart.scales.x.getPixelForValue(marker.x);
                    const yBottom = chartArea.bottom;
                    const yTop = chartArea.top;
                    
                    // Draw vertical line
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yTop);
                    ctx.lineTo(x, yBottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = 'rgba(255, 99, 132, 0.8)';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    
                    // Draw delivery amount label
                    ctx.fillStyle = 'rgba(255, 99, 132, 0.9)';
                    ctx.font = '12px Arial';
                    ctx.fillText('D: ' + marker.amount, x + 5, yTop + 15);
                    ctx.restore();
                });
            }
        }]
    });
    
    function updateChart{{ loop.index }}(type) {
        let datasets = [];
        
        switch(type) {
            case 'consumption':
                datasets = [chartData{{ loop.index }}.datasets.consumption];
                break;
            case 'stock':
                datasets = [chartData{{ loop.index }}.datasets.stock];
                break;
            case 'combined':
                // Use dual y-axis for combined view
                datasets = [
                    {...chartData{{ loop.index }}.datasets.consumption, yAxisID: 'y'},
                    {...chartData{{ loop.index }}.datasets.stock, yAxisID: 'y1'}
                ];
                break;
        }
        
        chart{{ loop.index }}.data.datasets = datasets;
        
        // Update scales for combined view
        if (type === 'combined') {
            chart{{ loop.index }}.options.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Stock Level ({{ item.unit }})'
                },
                grid: {
                    drawOnChartArea: false,
                }
            };
            chart{{ loop.index }}.options.scales.y.title.text = 'Consumption ({{ item.unit }})';
        } else {
            delete chart{{ loop.index }}.options.scales.y1;
            chart{{ loop.index }}.options.scales.y.title.text = 'Amount ({{ item.unit }})';
        }
        
        chart{{ loop.index }}.update();
    }
    
    // Add event listeners for toggle buttons
    document.getElementById('consumption{{ loop.index }}').addEventListener('change', function() {
        if (this.checked) updateChart{{ loop.index }}('consumption');
    });
    
    document.getElementById('stock{{ loop.index }}').addEventListener('change', function() {
        if (this.checked) updateChart{{ loop.index }}('stock');
    });
    
    document.getElementById('combined{{ loop.index }}').addEventListener('change', function() {
        if (this.checked) updateChart{{ loop.index }}('combined');
    });
})();
{% endif %}
{% endfor %}
{% endif %}

// Toggle functionality for forecast items
document.addEventListener('DOMContentLoaded', function() {
    const toggleHeaders = document.querySelectorAll('.item-toggle-header');
    
    toggleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const itemId = this.dataset.item;
            const content = document.getElementById('content-' + itemId);
            const toggleIcon = this.querySelector('.toggle-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                // Show content
                content.style.display = 'block';
                toggleIcon.classList.remove('bi-chevron-down');
                toggleIcon.classList.add('bi-chevron-up');
                this.style.backgroundColor = '#f8f9fa';
            } else {
                // Hide content
                content.style.display = 'none';
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
                this.style.backgroundColor = '';
            }
        });
        
        // Add hover effect
        header.addEventListener('mouseenter', function() {
            if (this.style.backgroundColor === '') {
                this.style.backgroundColor = '#f8f9fa';
            }
        });
        
        header.addEventListener('mouseleave', function() {
            const itemId = this.dataset.item;
            const content = document.getElementById('content-' + itemId);
            if (content.style.display === 'none' || content.style.display === '') {
                this.style.backgroundColor = '';
            }
        });
    });
});

// Handle recalculate button
document.getElementById('recalculateBtn').addEventListener('click', function() {
    this.innerHTML = '<i class="bi bi-hourglass"></i> Recalculating...';
    this.disabled = true;
    
    fetch('/api/recalculate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.message);
                location.reload();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Network error: ' + error);
        })
        .finally(() => {
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Recalculate Analytics';
            this.disabled = false;
        });
});
</script>
{% endblock %}